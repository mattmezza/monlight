# Monlight monitoring stack - pulls pre-built images from GHCR.
#
# Quick start:
#   1. cp deploy/secrets.env.example deploy/secrets.env
#   2. Edit deploy/secrets.env with your API keys
#   3. docker compose up -d
#
# To pin a specific version, replace :latest with a version tag:
#   image: ghcr.io/mattmezza/monlight/error-tracker:0.2.0

services:
  error-tracker:
    image: ghcr.io/mattmezza/monlight/error-tracker:latest
    ports:
      - "5010:8000"
    volumes:
      - error-tracker-data:/app/data
    env_file:
      - deploy/secrets.env
    environment:
      - DATABASE_PATH=/app/data/errors.db
      - API_KEY=${ERROR_TRACKER_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 30M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/app/error-tracker", "--healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - monlight

  log-viewer:
    image: ghcr.io/mattmezza/monlight/log-viewer:latest
    ports:
      - "5011:8000"
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - log-viewer-data:/app/data
    env_file:
      - deploy/secrets.env
    environment:
      - DATABASE_PATH=/app/data/logs.db
      - API_KEY=${LOG_VIEWER_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CONTAINERS=${CONTAINERS:-}
    deploy:
      resources:
        limits:
          memory: 30M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/app/log-viewer", "--healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - monlight

  metrics-collector:
    image: ghcr.io/mattmezza/monlight/metrics-collector:latest
    ports:
      - "5012:8000"
    volumes:
      - metrics-collector-data:/app/data
    env_file:
      - deploy/secrets.env
    environment:
      - DATABASE_PATH=/app/data/metrics.db
      - API_KEY=${METRICS_COLLECTOR_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 30M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/app/metrics-collector", "--healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - monlight

  browser-relay:
    image: ghcr.io/mattmezza/monlight/browser-relay:latest
    ports:
      - "5013:8000"
    volumes:
      - browser-relay-data:/app/data
    env_file:
      - deploy/secrets.env
    environment:
      - DATABASE_PATH=/app/data/browser-relay.db
      - ADMIN_API_KEY=${BROWSER_RELAY_ADMIN_API_KEY}
      - ERROR_TRACKER_URL=http://error-tracker:8000
      - ERROR_TRACKER_API_KEY=${ERROR_TRACKER_API_KEY}
      - METRICS_COLLECTOR_URL=http://metrics-collector:8000
      - METRICS_COLLECTOR_API_KEY=${METRICS_COLLECTOR_API_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    deploy:
      resources:
        limits:
          memory: 30M
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/app/browser-relay", "--healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      error-tracker:
        condition: service_healthy
      metrics-collector:
        condition: service_healthy
    networks:
      - monlight

volumes:
  error-tracker-data:
  log-viewer-data:
  metrics-collector-data:
  browser-relay-data:

networks:
  monlight:
